<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Live Scanner Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #ef5350; --dark: #1a1a1a; --card: #2d2d2d; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .panel { width: 90%; max-width: 400px; background: var(--card); padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #444; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #aaa; text-transform: uppercase; margin-bottom: 5px; }
        input { width: 100%; background: #111; border: 1px solid #555; padding: 12px; color: white; border-radius: 8px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
        .preview { display: flex; background: #111; padding: 15px; border-radius: 10px; align-items: center; gap: 15px; min-height: 120px; border: 1px dashed #555; margin: 15px 0; }
        .preview img { width: 85px; border-radius: 5px; display: none; }
        button { width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-search { background: #3b4cca; color: white; padding: 12px; margin-bottom: 10px; }
        .btn-save { background: #2e7d32; color: white; padding: 16px; font-size: 16px; margin-top: 10px; }
        .btn-save:disabled { background: #555; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="panel">
    <h2>Scanner Pokémon JPN</h2>
    
    <div class="row">
        <div>
            <label>Set ID (ex: s9a)</label>
            <input type="text" id="setID" placeholder="Ex: sv8a">
        </div>
        <div>
            <label>Número (ex: 45)</label>
            <input type="text" id="cardNum" placeholder="Ex: 045">
        </div>
    </div>
    <button class="btn-search" onclick="buscar()">Pesquisar Carta</button>

    <div class="preview">
        <img id="cardImg" src="">
        <div id="cardInfo">Aguardando dados...</div>
    </div>

    <label>E-mail do Vencedor</label>
    <input type="email" id="userEmail" placeholder="vencedor@email.com" style="margin-bottom: 15px;">
    
    <label>Valor da Venda (R$)</label>
    <input type="number" id="valor" placeholder="0.00">

    <button id="btnSave" class="btn-save" onclick="salvar()" disabled>CREDITAR NO SUPABASE</button>
</div>

<script>
    // --- CHAVES ---
    const POKEMON_KEY = 'SUA_API_KEY_POKEMON';
    const SBA_URL = 'SUA_URL_SUPABASE';
    const SBA_KEY = 'SUA_KEY_ANON';
    const supabase = window.supabase.createClient(SBA_URL, SBA_KEY);

    let cartaEncontrada = null;

    async function buscar() {
        const set = document.getElementById('setID').value.trim().toLowerCase();
        let num = document.getElementById('cardNum').value.trim().split('/')[0];
        const info = document.getElementById('cardInfo');
        const img = document.getElementById('cardImg');

        info.innerText = "Buscando...";
        img.style.display = "none";

        try {
            // Usando o Proxy da Cloudflare (muito estável) para evitar o CORS
            const target = `https://api.pokemontcg.io/v2/cards?q=set.id:${set} number:${num}&pageSize=1`;
            const proxy = `https://corsproxy.io/?${encodeURIComponent(target)}`;

            const res = await fetch(proxy, { headers: { 'X-Api-Key': POKEMON_KEY } });
            const json = await res.json();

            if (json.data && json.data[0]) {
                cartaEncontrada = json.data[0];
                img.src = cartaEncontrada.images.small;
                img.style.display = "block";
                info.innerHTML = `<strong>${cartaEncontrada.name}</strong><br><small>${cartaEncontrada.set.name}</small>`;
                document.getElementById('btnSave').disabled = false;
            } else {
                info.innerText = "Não encontrada!";
                document.getElementById('btnSave').disabled = true;
            }
        } catch (e) {
            info.innerText = "Erro na busca.";
            console.error(e);
        }
    }

    async function salvar() {
        const email = document.getElementById('userEmail').value;
        const valor = document.getElementById('valor').value;
        const btn = document.getElementById('btnSave');

        if(!email) return alert("Digite o e-mail!");

        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
            const { data: user } = await supabase.from('perfis').select('id').eq('email_contato', email).single();
            if (!user) throw new Error("Cliente não encontrado");

            await supabase.from('inventario').insert([{
                user_id: user.id,
                nome_pokemon: cartaEncontrada.name,
                set_codigo: cartaEncontrada.set.id,
                numero_card: cartaEncontrada.number,
                preco_pago: parseFloat(valor) || 0,
                status: 'No Fichário'
            }]);

            alert("✅ SUCESSO!");
            document.getElementById('cardNum').value = "";
            document.getElementById('valor').value = "";
        } catch (e) {
            alert(e.message);
        } finally {
            btn.innerText = "CREDITAR NO SUPABASE";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>