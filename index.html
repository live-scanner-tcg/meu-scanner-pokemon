<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Scanner Pokemon Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; display: flex; justify-content: center; }
        .box { width: 100%; max-width: 380px; background: #222; padding: 20px; border-radius: 15px; border: 1px solid #333; }
        input { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #000; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #3B4CCA; color: white; margin-bottom: 15px; }
        .btn-green { background: #28a745; color: white; }
        .preview { display: flex; align-items: center; gap: 15px; background: #1a1a1a; padding: 10px; border-radius: 10px; min-height: 100px; margin-bottom: 15px; }
        #cardImg { width: 80px; display: none; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2>Scanner Direto V2</h2>
    
    <label>Set (ex: sv8a)</label>
    <input type="text" id="setID" placeholder="Coleção">
    
    <label>Número (ex: 127)</label>
    <input type="text" id="cardNum" placeholder="Número">
    
    <button class="btn-blue" onclick="buscarCarta()">PESQUISAR</button>

    <div class="preview">
        <img id="cardImg" src="">
        <div id="cardInfo">Aguardando busca...</div>
    </div>

    <input type="email" id="userEmail" placeholder="E-mail do Cliente">
    <input type="number" id="valor" placeholder="Valor R$">
    
    <button class="btn-green" id="btnSave" onclick="salvar()" disabled>CREDITAR CARTA</button>
</div>

<script>
    // --- CONFIGURAÇÃO (Troque pelos seus dados) ---
    const POKEMON_KEY = 'd18f5a1e-b4db-49ad-841b-6809c5f0515c'; 
    const SB_URL = 'https://hqmxcqhvwlvyellolhkm.supabase.co';
    const SB_KEY = 'sb_publishable_CvY0uDpQZDPSnQixxh7uSA_8cYwqumF';

    // Mudamos o nome para supabaseClient para evitar o erro de "already declared"
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let cartaEncontrada = null;

    async function buscarCarta() {
        const set = document.getElementById('setID').value.trim().toLowerCase();
        let numInput = document.getElementById('cardNum').value.trim();
        let num = numInput.includes('/') ? numInput.split('/')[0] : numInput;
        
        const info = document.getElementById('cardInfo');
        const img = document.getElementById('cardImg');

        info.innerText = "Buscando...";
        
        try {
            const url = `https://api.pokemontcg.io/v2/cards?q=set.id:${set} number:${num}`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Api-Key': POKEMON_KEY,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.data && result.data.length > 0) {
                cartaEncontrada = result.data[0];
                img.src = cartaEncontrada.images.small;
                img.style.display = "block";
                info.innerHTML = `<strong>${cartaEncontrada.name}</strong><br>${cartaEncontrada.set.name}`;
                document.getElementById('btnSave').disabled = false;
            } else {
                img.style.display = "none";
                info.innerText = "Carta não encontrada.";
            }
        } catch (e) {
            info.innerText = "Erro: " + e.message;
        }
    }

    async function salvar() {
        const email = document.getElementById('userEmail').value;
        const valorVenda = document.getElementById('valor').value;
        const btn = document.getElementById('btnSave');

        if (!email || !cartaEncontrada) return alert("Preencha o e-mail!");

        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
            // Usando o novo nome da variável cliente
            const { data: user, error: userError } = await supabaseClient
                .from('perfis')
                .select('id')
                .eq('email_contato', email)
                .single();
            
            if (userError || !user) throw new Error("Usuário não encontrado.");

            const { error: invError } = await supabaseClient
                .from('inventario')
                .insert([{
                    user_id: user.id,
                    nome_pokemon: cartaEncontrada.name,
                    set_codigo: cartaEncontrada.set.id,
                    numero_card: cartaEncontrada.number,
                    preco_pago: parseFloat(valorVenda) || 0,
                    status: 'No Fichário'
                }]);

            if (invError) throw invError;

            alert("Cartinha cadastrada com sucesso!");
            document.getElementById('cardNum').value = "";
            document.getElementById('valor').value = "";
        } catch (e) {
            alert("Erro: " + e.message);
        } finally {
            btn.innerText = "CREDITAR CARTA";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>