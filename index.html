<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Pokemon JPN Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3B4CCA; --success: #2e7d32; --bg: #121212; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #333; }
        
        /* Cabeçalho */
        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { color: #FFCB05; margin: 0; font-size: 22px; text-shadow: 2px 2px #3B4CCA; }
        
        /* Busca */
        .search-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input { background: #000; border: 1px solid #444; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn-search { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Galeria Rápida */
        #galeria { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin: 20px 0; 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 10px;
            background: #111;
            border-radius: 10px;
        }
        .card-item { background: #2a2a2a; padding: 5px; border-radius: 8px; text-align: center; border: 2px solid transparent; transition: 0.2s; cursor: pointer; }
        .card-item:hover { border-color: var(--primary); }
        .card-item.selected { border-color: #FFCB05; background: #333; }
        .card-item img { width: 100%; border-radius: 4px; aspect-ratio: 2/3; background: #333; }
        .card-item span { font-size: 9px; color: #aaa; display: block; margin-top: 3px; }

        /* Formulário de Salvar */
        .save-area { border-top: 1px solid #333; padding-top: 20px; margin-top: 10px; }
        .btn-save { width: 100%; background: var(--success); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-save:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Scrollbar Style */
        #galeria::-webkit-scrollbar { width: 5px; }
        #galeria::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Scanner JPN V2</h2>
        <p style="font-size: 12px; color: #888;">Busca otimizada para coleções japonesas</p>
    </div>

    <div class="search-box">
        <input type="text" id="setID" placeholder="Set (ex: sv8a)">
        <input type="text" id="cardNum" placeholder="Nº (ex: 045)">
    </div>
    <button class="btn-search" onclick="buscar()">BUSCAR NA COLEÇÃO</button>

    <div id="galeria">
        <p style="grid-column: 1/-1; text-align: center; color: #666; font-size: 13px;">Digite o Set para carregar as artes</p>
    </div>

    <div class="save-area">
        <label style="font-size: 11px; color: #888;">CLIENTE (E-MAIL)</label>
        <input type="email" id="userEmail" placeholder="vendedor@email.com" style="margin-bottom: 10px;">
        
        <label style="font-size: 11px; color: #888;">VALOR DA VENDA (R$)</label>
        <input type="number" id="valorVenda" placeholder="0.00">

        <button id="btnSave" class="btn-save" onclick="salvar()" disabled>CREDITAR PARA CLIENTE</button>
    </div>
</div>

<script>
    // --- CONFIGURAÇÃO ---
    const SB_URL = 'https://hqmxcqhvwlvyellolhkm.supabase.co';
    const SB_KEY = 'sb_publishable_CvY0uDpQZDPSnQixxh7uSA_8cYwqumF';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let cartaSelecionada = null;

    // 1. Busca rápida via API Bridge (Vercel)
    async function buscar() {
        const set = document.getElementById('setID').value.trim().toLowerCase();
        let num = document.getElementById('cardNum').value.trim();
        const galeria = document.getElementById('galeria');

        if(!set) return alert("Digite ao menos o código do Set!");

        galeria.innerHTML = "<p style='grid-column: 1/-1; text-align: center;'>Carregando miniaturas...</p>";

        try {
            // Chamando sua função em /api/pokemon.js
            const response = await fetch(`/api/pokemon?set=${set}&num=${num}`);
            const result = await response.json();

            if (result.data && result.data.length > 0) {
                galeria.innerHTML = "";
                result.data.forEach(carta => {
                    const item = document.createElement('div');
                    item.className = 'card-item';
                    item.id = `card-${carta.id}`;
                    item.onclick = () => clicarCarta(carta);
                    item.innerHTML = `
                        <img src="${carta.images.small}" loading="lazy">
                        <span>#${carta.number}</span>
                    `;
                    galeria.appendChild(item);
                });
            } else {
                galeria.innerHTML = "<p style='grid-column: 1/-1; text-align: center; color: red;'>Set não encontrado.</p>";
            }
        } catch (err) {
            galeria.innerHTML = "<p style='grid-column: 1/-1; text-align: center;'>Erro ao conectar.</p>";
        }
    }

    // 2. Seleção visual
    function clicarCarta(carta) {
        // Remove seleção anterior
        document.querySelectorAll('.card-item').forEach(el => el.classList.remove('selected'));
        // Adiciona nova seleção
        document.getElementById(`card-${carta.id}`).classList.add('selected');
        
        cartaSelecionada = carta;
        document.getElementById('btnSave').disabled = false;
        document.getElementById('btnSave').innerText = `CREDITAR: ${carta.name}`;
    }

    // 3. Salvar no Supabase
    async function salvar() {
        const email = document.getElementById('userEmail').value.trim();
        const valor = document.getElementById('valorVenda').value;
        const btn = document.getElementById('btnSave');

        if(!email) return alert("E-mail do cliente é obrigatório!");

        btn.innerText = "Salvando no Banco...";
        btn.disabled = true;

        try {
            // Busca o ID do perfil
            const { data: user, error: userErr } = await _supabase.from('perfis').select('id').eq('email_contato', email).single();
            
            if (userErr || !user) throw new Error("Cliente não encontrado.");

            // Insere no inventário
            const { error: invErr } = await _supabase.from('inventario').insert([{
                user_id: user.id,
                nome_pokemon: cartaSelecionada.name,
                set_codigo: cartaSelecionada.id.split('-')[0],
                numero_card: cartaSelecionada.number,
                preco_pago: parseFloat(valor) || 0,
                status: 'No Fichário'
            }]);

            if (invErr) throw invErr;

            alert("✅ SUCESSO! Carta adicionada ao cliente.");
            // Reset parcial
            document.getElementById('valorVenda').value = "";
        } catch (err) {
            alert("Erro: " + err.message);
        } finally {
            btn.innerText = "CREDITAR PARA CLIENTE";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>