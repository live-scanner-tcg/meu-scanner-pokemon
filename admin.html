<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Registro R√°pido (10+ Cartas)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --blue: #3B4CCA; --gold: #FFCB05; --bg: #0a0a0a; --card: #161616; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .counter { background: var(--gold); color: black; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }

        .section { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid #222; }
        label { display: block; margin-bottom: 4px; color: var(--gold); font-size: 12px; font-weight: bold; text-transform: uppercase; }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; font-size: 16px; }

        /* √Årea da C√¢mera Otimizada */
        .camera-area { position: relative; width: 100%; height: 200px; background: #000; border: 2px solid var(--blue); border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        #preview { width: 100%; height: 100%; object-fit: contain; display: none; }
        .guide { position: absolute; width: 85%; height: 70%; border: 1px dashed rgba(255,255,255,0.4); pointer-events: none; display: flex; align-items: center; justify-content: center; color: #555; font-size: 12px; }

        .btn { width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-photo { background: var(--blue); color: white; }
        .btn-save { background: #2e7d32; color: white; margin-top: 5px; }
        
        /* Feedback de carregamento */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="header">
        <h3 style="color: var(--gold); margin:0;">Admin Scanner</h3>
        <div class="counter">Cartas nesta rodada: <span id="count">0</span></div>
    </div>

    <div class="section" style="border-left: 4px solid var(--gold);">
        <label>üë§ Nick/ID do Cliente (Fixo)</label>
        <input type="text" id="userIdentifier" placeholder="Nick do Cliente">
    </div>

    <div class="section">
        <div class="camera-area">
            <div class="guide" id="guideText">ENQUADRE A CARTA</div>
            <img id="preview">
        </div>
        <label for="fotoInput" class="btn btn-photo" style="display: block; text-align: center;">üì∏ TIRAR FOTO</label>
        <input type="file" id="fotoInput" accept="image/*" capture="environment" style="display:none">

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>N√öMERO</label>
                <input type="text" id="cardNumber" placeholder="045/180">
            </div>
            <div style="flex: 1;">
                <label>COLE√á√ÉO</label>
                <input type="text" id="cardSet" placeholder="sv8a">
            </div>
        </div>
        
        <button id="btnSalvar" class="btn btn-save" onclick="salvarCarta()">üíæ SALVAR E PR√ìXIMA</button>
    </div>

    <div id="loading" class="loading-overlay">
        <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p>Enviando carta...</p>
    </div>

    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <script>
        // CONFIGURA√á√ÉO SUPABASE
        const SUPABASE_URL = 'https://hqmxcqhvwlvyellolhkm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_CvY0uDpQZDPSnQixxh7uSA_8cYwqumF';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let cartaContador = 0;
        const fotoInput = document.getElementById('fotoInput');
        const preview = document.getElementById('preview');
        const guideText = document.getElementById('guideText');

        fotoInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                guideText.style.display = 'none';
            }
        };

        async function salvarCarta() {
            const user = document.getElementById('userIdentifier').value;
            const file = fotoInput.files[0];
            const num = document.getElementById('cardNumber').value;
            const set = document.getElementById('cardSet').value;
            const loading = document.getElementById('loading');

            if (!user || !file || !num || !set) {
                alert("Preencha todos os campos da carta!");
                return;
            }

            loading.style.display = 'flex';

            try {
                // 1. Upload da Foto
                const fileName = `portfolio/${Date.now()}_${user}.jpg`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('fotos-cartas')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage.from('fotos-cartas').getPublicUrl(fileName);
                const publicUrl = urlData.publicUrl;

                // 2. Salvar no Banco
                const { error: dbError } = await supabase
                    .from('portfolio_clientes')
                    .insert([{ 
                        email: user, 
                        nome_carta: `${set.toUpperCase()} ${num}`, 
                        url_foto: publicUrl 
                    }]);

                if (dbError) throw dbError;

                // 3. Reset para a PR√ìXIMA CARTA
                cartaContador++;
                document.getElementById('count').innerText = cartaContador;
                
                // Limpa campos da carta mas mant√©m o Nick
                fotoInput.value = "";
                preview.style.display = 'none';
                guideText.style.display = 'flex';
                document.getElementById('cardNumber').value = "";
                document.getElementById('cardSet').value = "";
                
                // Pequeno feedback visual de sucesso
                loading.style.display = 'none';
                console.log("Carta salva!");

            } catch (err) {
                alert("Erro: " + err.message);
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>