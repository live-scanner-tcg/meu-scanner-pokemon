<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Scanner JPN - Google Vision</title>
    <style>
        :root { --primary: #3B4CCA; --accent: #FFCB05; --bg: #0f0f0f; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { color: var(--accent); margin-bottom: 5px; }
        
        /* Container da Foto */
        .preview-box { 
            width: 100%; height: 280px; background: #1a1a1a; 
            border: 2px solid var(--primary); border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; position: relative; margin-bottom: 15px;
        }
        #imgPreview { width: 100%; height: 100%; object-fit: contain; display: none; }
        .placeholder-text { color: #555; text-align: center; }

        /* Bot√µes */
        .btn { 
            display: block; width: 100%; padding: 15px; border: none; 
            border-radius: 10px; font-weight: bold; font-size: 16px; 
            cursor: pointer; transition: 0.2s; text-align: center; box-sizing: border-box;
        }
        .btn-camera { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-scan { background: var(--accent); color: black; display: none; margin-bottom: 10px; }
        .btn-save { background: #2e7d32; color: white; }
        .btn:active { transform: scale(0.98); }

        /* Painel de Resultados */
        .result-panel { 
            background: var(--card); padding: 20px; border-radius: 15px; 
            margin-top: 20px; display: none; border: 1px solid #333; 
        }
        .data-detected { color: var(--accent); font-family: monospace; font-size: 1.1em; background: #000; padding: 10px; border-radius: 5px; }
        
        input { 
            width: 100%; padding: 12px; margin: 10px 0; background: #000; 
            border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; 
        }
        
        #status { font-size: 14px; text-align: center; margin-top: 10px; color: #aaa; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Scanner Admin</h2>
        <small>Identificador de Cartas Japonesas</small>
    </div>

    <div class="preview-box">
        <span class="placeholder-text" id="label">üì∑ Aponte para o rodap√© da carta</span>
        <img id="imgPreview">
    </div>

    <label for="fileInput" class="btn btn-camera">TIRAR FOTO DA CARTA</label>
    <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">

    <button id="scanBtn" class="btn btn-scan" onclick="processarComGoogle()">üîç ANALISAR AGORA</button>

    <div id="status"></div>

    <div id="resultPanel" class="result-panel">
        <h3 style="margin-top:0">Dados Encontrados:</h3>
        <div id="resText" class="data-detected">...</div>
        
        <hr style="border:0; border-top: 1px solid #333; margin: 20px 0;">
        
        <label>E-mail do Cliente:</label>
        <input type="email" id="clientEmail" placeholder="cliente@email.com">
        
        <label>Pre√ßo Sugerido (R$):</label>
        <input type="number" id="cardVal" placeholder="Ex: 50.00">
        
        <button class="btn btn-save" onclick="salvarNoSupabase()">ENVIAR PARA USU√ÅRIO</button>
    </div>

    <script>
        // SUA API KEY J√Å CONFIGURADA
        const API_KEY = "AIzaSyAGiv9l75QyhNdfYQoVPMJUgRBZ4fNzWi0"; 
        
        const fileInput = document.getElementById('fileInput');
        const imgPreview = document.getElementById('imgPreview');
        const scanBtn = document.getElementById('scanBtn');
        const status = document.getElementById('status');
        const resultPanel = document.getElementById('resultPanel');

        let base64Image = "";

        // Captura a imagem do celular
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                base64Image = reader.result.split(',')[1];
                imgPreview.src = reader.result;
                imgPreview.style.display = "block";
                document.getElementById('label').style.display = "none";
                scanBtn.style.display = "block";
                resultPanel.style.display = "none";
                status.innerText = "Foto pronta para an√°lise!";
            };
            reader.readAsDataURL(file);
        };

        // Envia para o Google Vision
        async function processarComGoogle() {
            status.innerText = "‚è≥ Google Vision identificando texto...";
            scanBtn.disabled = true;
            scanBtn.style.opacity = "0.5";

            const url = `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;
            
            const payload = {
    requests: [{
        image: { content: base64Image },
        features: [
            { type: "TEXT_DETECTION" },
            { type: "DOCUMENT_TEXT_DETECTION" } // Adicione isso aqui!
        ]
    }]
};

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                console.log("Resposta do Google:", data);
                
                if (data.responses && data.responses[0].fullTextAnnotation) {
                    const textoDetectado = data.responses[0].fullTextAnnotation.text;
                    exibirResultado(textoDetectado);
                } else {
                    status.innerText = "‚ùå Nenhum texto encontrado. Tente focar no rodap√©.";
                    scanBtn.disabled = false;
                    scanBtn.style.opacity = "1";
                }
            } catch (err) {
                status.innerText = "‚ùå Erro na conex√£o com Google.";
                scanBtn.disabled = false;
                scanBtn.style.opacity = "1";
            }
        }

        // Exibe o que o Google "leu" na carta
        function exibirResultado(texto) {
            status.innerText = "‚úÖ Identifica√ß√£o conclu√≠da!";
            resultPanel.style.display = "block";
            
            // Tenta achar padr√µes de n√∫meros como 045/180
            const regexNumero = /\d{3}\/\d{3}/;
            const match = texto.match(regexNumero);
            const numeroIdentificado = match ? match[0] : "N√∫mero n√£o vis√≠vel";

            document.getElementById('resText').innerText = `ID/N¬∫: ${numeroIdentificado}\nTexto: ${texto.substring(0, 50)}...`;
            
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function salvarNoSupabase() {
            const email = document.getElementById('clientEmail').value;
            if (!email) {
                alert("Por favor, digite o e-mail do cliente.");
                return;
            }
            // Aqui integraremos com seu c√≥digo do Supabase
            alert("Sucesso! Dados prontos para o banco de dados.");
        }
    </script>
</body>
</html>