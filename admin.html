<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Scanner - Produ√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --blue: #3B4CCA; --gold: #FFCB05; --bg: #0a0a0a; --card: #161616; --green: #2e7d32; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .counter { background: var(--gold); color: black; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 13px; }
        .section { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid #222; }
        label { display: block; margin-bottom: 6px; color: var(--gold); font-size: 11px; font-weight: bold; text-transform: uppercase; }
        input { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; font-size: 16px; }
        .camera-preview { position: relative; width: 100%; height: 220px; background: #000; border: 2px solid var(--blue); border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #imgPreview { width: 100%; height: 100%; object-fit: contain; display: none; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-photo { background: var(--blue); color: white; margin-bottom: 10px; }
        .btn-save { background: var(--green); color: white; margin-top: 10px; }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="header">
        <h3 style="margin:0;">Admin Scanner</h3>
        <div class="counter">Cartas: <span id="count">0</span></div>
    </div>

    <div class="section">
        <label>üë§ Selecionar Cliente</label>
        <input type="text" id="userIdentifier" list="listaUsuarios" placeholder="Digite o nome do cliente...">
        <datalist id="listaUsuarios"></datalist>
        <div id="userStatus" style="font-size: 12px; color: #888;">Sincronizando banco...</div>
    </div>

    <div class="section">
        <label>üì∏ Foto da Carta</label>
        <div class="camera-preview">
            <img id="imgPreview">
        </div>
        <label for="fotoInput" class="btn btn-photo" style="display: block; text-align: center; margin-top: 10px;">TIRAR FOTO</label>
        <input type="file" id="fotoInput" accept="image/*" capture="environment" style="display:none">

        <div style="display: flex; gap: 10px;">
            <input type="text" id="cardSet" placeholder="Cole√ß√£o (ex: sv8a)">
            <input type="text" id="cardNumber" placeholder="N¬∫ (ex: 045/180)">
        </div>
        <button id="btnSalvar" class="btn btn-save">SALVAR NO PORTF√ìLIO</button>
    </div>

    <div id="loading">
        <div style="color:var(--gold)">‚è≥ Enviando...</div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO SUPABASE ---
        const SB_URL = 'https://hqmxcqhvwlvyellolhkm.supabase.co';
        const SB_KEY = 'sb_publishable_CvY0uDpQZDPSnQixxh7uSA_8cYwqumF';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        const userInp = document.getElementById('userIdentifier');
        const datalist = document.getElementById('listaUsuarios');
        const statusTxt = document.getElementById('userStatus');
        let listaLocalPerfis = []; 

        // 1. BUSCA OS NOMES DA TABELA "PERFIS"
        async function sincronizarPerfis() {
            try {
                const { data, error } = await supabaseClient
                    .from('perfis') 
                    .select('id, nome_completo');

                if (error) throw error;

                listaLocalPerfis = data;
                datalist.innerHTML = "";
                data.forEach(p => {
                    if(p.nome_completo) {
                        let opt = document.createElement('option');
                        opt.value = p.nome_completo; 
                        datalist.appendChild(opt);
                    }
                });
                statusTxt.innerText = "‚úÖ Clientes carregados.";
            } catch (err) {
                statusTxt.innerText = "‚ùå Erro ao carregar perfis.";
                console.error(err);
            }
        }

        sincronizarPerfis();

        // Valida√ß√£o visual
        userInp.addEventListener('input', () => {
            const encontrado = listaLocalPerfis.find(p => p.nome_completo === userInp.value);
            statusTxt.innerHTML = encontrado ? 
                `<span style="color:var(--gold)">‚úÖ Cliente: ${encontrado.nome_completo}</span>` : 
                `<span style="color:#888">‚ùì Nome n√£o encontrado no banco</span>`;
        });

        // L√ìGICA DE FOTO E SALVAMENTO
        const fotoInp = document.getElementById('fotoInput');
        const imgPrev = document.getElementById('imgPreview');
        const btnSave = document.getElementById('btnSalvar');
        const loading = document.getElementById('loading');
        let contador = 0;

        fotoInp.onchange = (e) => {
            if (e.target.files[0]) {
                imgPrev.src = URL.createObjectURL(e.target.files[0]);
                imgPrev.style.display = 'block';
            }
        };

        btnSave.onclick = async () => {
            const user = userInp.value;
            const file = fotoInp.files[0];
            const set = document.getElementById('cardSet').value;
            const num = document.getElementById('cardNumber').value;

            if (!user || !file || !set || !num) return alert("Faltam informa√ß√µes!");

            loading.style.display = 'flex';

            try {
                // Upload Foto
                const fileName = `portfolio/${Date.now()}.jpg`;
                const { data: upData, error: upErr } = await supabaseClient.storage
                    .from('fotos-cartas')
                    .upload(fileName, file);

                if (upErr) throw upErr;
                const { data: urlData } = supabaseClient.storage.from('fotos-cartas').getPublicUrl(fileName);

                // Salva no Portf√≥lio
                const { error: dbErr } = await supabaseClient
                    .from('portfolio_clientes')
                    .insert([{ 
                        email: user, // Salvando o nome completo no campo email por enquanto
                        nome_carta: `${set.toUpperCase()} ${num}`, 
                        url_foto: urlData.publicUrl 
                    }]);

                if (dbErr) throw dbErr;

                contador++;
                document.getElementById('count').innerText = contador;
                fotoInp.value = "";
                imgPrev.style.display = 'none';
                document.getElementById('cardSet').value = "";
                document.getElementById('cardNumber').value = "";
                alert("Carta salva com sucesso!");

            } catch (err) {
                alert("Erro: " + err.message);
            } finally {
                loading.style.display = 'none';
            }
        };
    </script>
</body>
</html>